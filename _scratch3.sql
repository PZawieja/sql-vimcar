SELECT c.creator , c.modifier, count(DISTINCT ctr.outbound_id)
FROM public.invoice i
         JOIN customer c
              ON c.id = i.customer_id
         JOIN contract ctr
              ON i.contract_id = ctr.id
         JOIN payment p
              ON p.invoice_id = i.id
WHERE 1=1
  AND ctr.outbound_id IN (
                          'V17665452',
                          'V30026123',
                          'V48536203',
                          'V44999343',
                          'V71616413',
                          'V32509229',
                          'V59036640',
                          'V32228945',
                          'V31625628',
                          'V92279092',
                          'V71633441',
                          'V40781258',
                          'V36797271',
                          'V89301075',
                          'V54232911',
                          'V95631569',
                          'V20678740',
                          'V68960145',
                          'V40085469',
                          'V58454996',
                          'V65630617',
                          'V27667110',
                          'V22736785',
                          'V70950827',
                          'V32543756',
                          'V60535717',
                          'V11130128',
                          'V81501940',
                          'V69420303',
                          'V78219763',
                          'V68988917',
                          'V63211766',
                          'V37941707',
                          'V95623034',
                          'V75912969',
                          'V73338390',
                          'V12595330',
                          'V95644986',
                          'V33287344',
                          'V19404956',
                          'V98065300',
                          'V29965353',
                          'V67360008',
                          'V55223151',
                          'V75106071',
                          'V48953653',
                          'V10004020',
                          'V40551651',
                          'V67245360',
                          'V71289183',
                          'V21226773',
                          'V61184995',
                          'V85832149',
                          'V43256018',
                          'V29494430',
                          'V40102665',
                          'V26861450',
                          'V84985002',
                          'V78726006',
                          'V57751412',
                          'V17968719',
                          'V84112034',
                          'V69765902',
                          'V38995853',
                          'V48825173',
                          'V73250031',
                          'V99861367',
                          'V55228127',
                          'V21356007',
                          'V53014833',
                          'V42261242',
                          'V76595372',
                          'V33729854',
                          'V49888004',
                          'V76180178',
                          'V67289002',
                          'V71512745',
                          'V86409334',
                          'V74841744',
                          'V76417200',
                          'V78502622',
                          'V52941288',
                          'V87798887',
                          'V29221980',
                          'V57509436',
                          'V51520286',
                          'V50593064',
                          'V91979515',
                          'V51704368',
                          'V51876914',
                          'V97242339',
                          'V65473267',
                          'V27733642',
                          'V91523963',
                          'V29328309',
                          'V47817633',
                          'V78582087',
                          'V77426919',
                          'V69659502',
                          'V15386254',
                          'V54143521',
                          'V19641551',
                          'V16967737',
                          'V69122249',
                          'V52440228',
                          'V79836645',
                          'V18047958',
                          'V44098209',
                          'V89283874',
                          'V77300575',
                          'V24223530',
                          'V86210185',
                          'V26496820',
                          'V99223959',
                          'V60619629',
                          'V28377805',
                          'V66904027',
                          'V74110779',
                          'V91105163',
                          'V59961693',
                          'V51078114',
                          'V55219439',
                          'V15481914',
                          'V37558868',
                          'V54531297',
                          'V44287434',
                          'V97731300',
                          'V16161200',
                          'V55344252',
                          'V57988775',
                          'V64181472',
                          'V27400152',
                          'V74091622',
                          'V36803414',
                          'V89529236',
                          'V13920968',
                          'V80343436',
                          'V48486199',
                          'V76318505',
                          'V41246295',
                          'V90373254',
                          'V19233109',
                          'V37913077',
                          'V42205273',
                          'V99211060',
                          'V22854730',
                          'V22387321',
                          'V21746555',
                          'V20925433',
                          'V32316186',
                          'V15140043',
                          'V42143382',
                          'V53711567',
                          'V67257456',
                          'V94882698',
                          'V70989286',
                          'V21254325',
                          'V62798404',
                          'V31380031',
                          'V80608998',
                          'V72599225',
                          'V69098461',
                          'V84497818',
                          'V63689248',
                          'V48823901',
                          'V27836787',
                          'V60005062',
                          'V20094710',
                          'V61872151',
                          'V39957239',
                          'V58148720',
                          'V99638556',
                          'V79362595',
                          'V31349016',
                          'V83309380',
                          'V62309154',
                          'V58988863',
                          'V76342651',
                          'V46535566',
                          'V32628390',
                          'V41921353',
                          'V95603952',
                          'V71437382',
                          'V14512221',
                          'V22057002',
                          'V55121766',
                          'V34379046',
                          'V79078988',
                          'V64193267',
                          'V44030013',
                          'V41139365',
                          'V91739055',
                          'V93839097',
                          'V52118630',
                          'V48972435',
                          'V39002137',
                          'V47922161',
                          'V96387893',
                          'V39853159',
                          'V37044774',
                          'V81420034',
                          'V80572087',
                          'V18024954',
                          'V99791967',
                          'V33658753',
                          'V69591311',
                          'V21059693',
                          'V30033007',
                          'V71635256',
                          'V84586455',
                          'V34240313',
                          'V10047323',
                          'V38913441',
                          'V39929552',
                          'V59397148',
                          'V44044321',
                          'V91778977',
                          'V25950106',
                          'V72928703',
                          'V85361553',
                          'V46970225',
                          'V61571721',
                          'V33785194',
                          'V14045924',
                          'V17867392',
                          'V80786644',
                          'V57854061',
                          'V14983949',
                          'V99639546',
                          'V21763794',
                          'V20813496',
                          'V11127915',
                          'V15770539',
                          'V63878597',
                          'V42617954',
                          'V70589541',
                          'V91953817',
                          'V99672271',
                          'V13696761',
                          'V46937875',
                          'V32904806',
                          'V45270925',
                          'V73224229',
                          'V41452786',
                          'V50585571',
                          'V53440359',
                          'V56730743',
                          'V50859507',
                          'V20837348',
                          'V32528880',
                          'V27516870',
                          'V57706132',
                          'V89639400',
                          'V12844619',
                          'V22698225',
                          'V59814680',
                          'V13815119',
                          'V64874589',
                          'V63595603',
                          'V49276407',
                          'V14354755',
                          'V52942328',
                          'V16873080',
                          'V90993926',
                          'V97599695',
                          'V23459253',
                          'V24829754',
                          'V32131526',
                          'V77233648',
                          'V53035852',
                          'V68162262',
                          'V57507647',
                          'V54235532',
                          'V61634222',
                          'V87227873',
                          'V38095603',
                          'V97578239',
                          'V63172090',
                          'V28417210',
                          'V82873041',
                          'V11367676',
                          'V79013744',
                          'V70595294',
                          'V89726690',
                          'V63708962',
                          'V21444153',
                          'V12245886',
                          'V65762453',
                          'V68165028',
                          'V64847131',
                          'V95181884',
                          'V18198118',
                          'V20425530',
                          'V60995740',
                          'V18774798',
                          'V12702217',
                          'V46381516',
                          'V19454404',
                          'V80859442',
                          'V93792811',
                          'V96477375',
                          'V95303388',
                          'V13118913',
                          'V63718987',
                          'V40187516',
                          'V91650578',
                          'V88951027',
                          'V60588687',
                          'V65151597',
                          'V67227861',
                          'V95716528',
                          'V79373814',
                          'V51260822',
                          'V57289474',
                          'V50172643',
                          'V91153842',
                          'V42543773',
                          'V37476478',
                          'V74716785',
                          'V83246232',
                          'V44528201',
                          'V55554270',
                          'V62957659',
                          'V57970348',
                          'V88015816',
                          'V80940729',
                          'V98960990',
                          'V36949349',
                          'V28832264',
                          'V66101901',
                          'V77490001',
                          'V97747048',
                          'V93472820',
                          'V61452885',
                          'V96456682',
                          'V24028633',
                          'V92377693',
                          'V44755417',
                          'V66928004',
                          'V38168774',
                          'V89758113',
                          'V58209551',
                          'V50960500',
                          'V35707117',
                          'V88012450',
                          'V27443820',
                          'V47009382',
                          'V83125056',
                          'V97933978',
                          'V17318574',
                          'V99093005',
                          'V71718058',
                          'V59870749',
                          'V78612256',
                          'V46970013',
                          'V24201065',
                          'V10545403',
                          'V46698407',
                          'V17876538',
                          'V32720407',
                          'V19254866',
                          'V97172273',
                          'V59160764',
                          'V27575597',
                          'V40790540',
                          'V95859609',
                          'V52007155',
                          'V35162689',
                          'V60308216',
                          'V11104505',
                          'V16327804',
                          'V55224810',
                          'V56718880',
                          'V36153163',
                          'V22164916',
                          'V50720722',
                          'V87694927',
                          'V51138236',
                          'V88182971',
                          'V61692389',
                          'V97889737',
                          'V49479737',
                          'V91923385',
                          'V93233183',
                          'V27623410',
                          'V38453110',
                          'V13282018',
                          'V20848276',
                          'V56456445',
                          'V35518891',
                          'V39414926',
                          'V80211316',
                          'V99533369',
                          'V10693725',
                          'V62774450',
                          'V73726273',
                          'V24342827',
                          'V92299092',
                          'V85174160',
                          'V93304459',
                          'V47836600',
                          'V41374838',
                          'V78021793',
                          'V59054623',
                          'V57890617',
                          'V70382321',
                          'V28797990',
                          'V28500236',
                          'V94907497',
                          'V50859780',
                          'V22191825',
                          'V75405938',
                          'V38248033',
                          'V45498796',
                          'V88096585',
                          'V15698626',
                          'V54647811',
                          'V66096503',
                          'V64604086',
                          'V33815363',
                          'V75720828',
                          'V39024348',
                          'V90987050',
                          'V52183348'
    )
GROUP BY c.creator, c.modifier;


-- Tatiana's modification of the customer:
SELECT *
FROM public.invoice i
         JOIN customer c
              ON c.id = i.customer_id
         JOIN contract ctr
              ON i.contract_id = ctr.id
         JOIN payment p
              ON p.invoice_id = i.id
WHERE 1=1
  AND c.modifier = 'urn:vimcar:com.vimcar:user/b59b3dca-c107-43e7-98a4-5910e32de133'
  AND ctr.outbound_id IN ('V17665452',
                          'V30026123',
                          'V48536203',
                          'V44999343',
                          'V71616413',
                          'V32509229',
                          'V59036640',
                          'V32228945',
                          'V31625628',
                          'V92279092',
                          'V71633441',
                          'V40781258',
                          'V36797271',
                          'V89301075',
                          'V54232911',
                          'V95631569',
                          'V20678740',
                          'V68960145',
                          'V40085469',
                          'V58454996',
                          'V65630617',
                          'V27667110',
                          'V22736785',
                          'V70950827',
                          'V32543756',
                          'V60535717',
                          'V11130128',
                          'V81501940',
                          'V69420303',
                          'V78219763',
                          'V68988917',
                          'V63211766',
                          'V37941707',
                          'V95623034',
                          'V75912969',
                          'V73338390',
                          'V12595330',
                          'V95644986',
                          'V33287344',
                          'V19404956',
                          'V98065300',
                          'V29965353',
                          'V67360008',
                          'V55223151',
                          'V75106071',
                          'V48953653',
                          'V10004020',
                          'V40551651',
                          'V67245360',
                          'V71289183',
                          'V21226773',
                          'V61184995',
                          'V85832149',
                          'V43256018',
                          'V29494430',
                          'V40102665',
                          'V26861450',
                          'V84985002',
                          'V78726006',
                          'V57751412',
                          'V17968719',
                          'V84112034',
                          'V69765902',
                          'V38995853',
                          'V48825173',
                          'V73250031',
                          'V99861367',
                          'V55228127',
                          'V21356007',
                          'V53014833',
                          'V42261242',
                          'V76595372',
                          'V33729854',
                          'V49888004',
                          'V76180178',
                          'V67289002',
                          'V71512745',
                          'V86409334',
                          'V74841744',
                          'V76417200',
                          'V78502622',
                          'V52941288',
                          'V87798887',
                          'V29221980',
                          'V57509436',
                          'V51520286',
                          'V50593064',
                          'V91979515',
                          'V51704368',
                          'V51876914',
                          'V97242339',
                          'V65473267',
                          'V27733642',
                          'V91523963',
                          'V29328309',
                          'V47817633',
                          'V78582087',
                          'V77426919',
                          'V69659502',
                          'V15386254',
                          'V54143521',
                          'V19641551',
                          'V16967737',
                          'V69122249',
                          'V52440228',
                          'V79836645',
                          'V18047958',
                          'V44098209',
                          'V89283874',
                          'V77300575',
                          'V24223530',
                          'V86210185',
                          'V26496820',
                          'V99223959',
                          'V60619629',
                          'V28377805',
                          'V66904027',
                          'V74110779',
                          'V91105163',
                          'V59961693',
                          'V51078114',
                          'V55219439',
                          'V15481914',
                          'V37558868',
                          'V54531297',
                          'V44287434',
                          'V97731300',
                          'V16161200',
                          'V55344252',
                          'V57988775',
                          'V64181472',
                          'V27400152',
                          'V74091622',
                          'V36803414',
                          'V89529236',
                          'V13920968',
                          'V80343436',
                          'V48486199',
                          'V76318505',
                          'V41246295',
                          'V90373254',
                          'V19233109',
                          'V37913077',
                          'V42205273',
                          'V99211060',
                          'V22854730',
                          'V22387321',
                          'V21746555',
                          'V20925433',
                          'V32316186',
                          'V15140043',
                          'V42143382',
                          'V53711567',
                          'V67257456',
                          'V94882698',
                          'V70989286',
                          'V21254325',
                          'V62798404',
                          'V31380031',
                          'V80608998',
                          'V72599225',
                          'V69098461',
                          'V84497818',
                          'V63689248',
                          'V48823901',
                          'V27836787',
                          'V60005062',
                          'V20094710',
                          'V61872151',
                          'V39957239',
                          'V58148720',
                          'V99638556',
                          'V79362595',
                          'V31349016',
                          'V83309380',
                          'V62309154',
                          'V58988863',
                          'V76342651',
                          'V46535566',
                          'V32628390',
                          'V41921353',
                          'V95603952',
                          'V71437382',
                          'V14512221',
                          'V22057002',
                          'V55121766',
                          'V34379046',
                          'V79078988',
                          'V64193267',
                          'V44030013',
                          'V41139365',
                          'V91739055',
                          'V93839097',
                          'V52118630',
                          'V48972435',
                          'V39002137',
                          'V47922161',
                          'V96387893',
                          'V39853159',
                          'V37044774',
                          'V81420034',
                          'V80572087',
                          'V18024954',
                          'V99791967',
                          'V33658753',
                          'V69591311',
                          'V21059693',
                          'V30033007',
                          'V71635256',
                          'V84586455',
                          'V34240313',
                          'V10047323',
                          'V38913441',
                          'V39929552',
                          'V59397148',
                          'V44044321',
                          'V91778977',
                          'V25950106',
                          'V72928703',
                          'V85361553',
                          'V46970225',
                          'V61571721',
                          'V33785194',
                          'V14045924',
                          'V17867392',
                          'V80786644',
                          'V57854061',
                          'V14983949',
                          'V99639546',
                          'V21763794',
                          'V20813496',
                          'V11127915',
                          'V15770539',
                          'V63878597',
                          'V42617954',
                          'V70589541',
                          'V91953817',
                          'V99672271',
                          'V13696761',
                          'V46937875',
                          'V32904806',
                          'V45270925',
                          'V73224229',
                          'V41452786',
                          'V50585571',
                          'V53440359',
                          'V56730743',
                          'V50859507',
                          'V20837348',
                          'V32528880',
                          'V27516870',
                          'V57706132',
                          'V89639400',
                          'V12844619',
                          'V22698225',
                          'V59814680',
                          'V13815119',
                          'V64874589',
                          'V63595603',
                          'V49276407',
                          'V14354755',
                          'V52942328',
                          'V16873080',
                          'V90993926',
                          'V97599695',
                          'V23459253',
                          'V24829754',
                          'V32131526',
                          'V77233648',
                          'V53035852',
                          'V68162262',
                          'V57507647',
                          'V54235532',
                          'V61634222',
                          'V87227873',
                          'V38095603',
                          'V97578239',
                          'V63172090',
                          'V28417210',
                          'V82873041',
                          'V11367676',
                          'V79013744',
                          'V70595294',
                          'V89726690',
                          'V63708962',
                          'V21444153',
                          'V12245886',
                          'V65762453',
                          'V68165028',
                          'V64847131',
                          'V95181884',
                          'V18198118',
                          'V20425530',
                          'V60995740',
                          'V18774798',
                          'V12702217',
                          'V46381516',
                          'V19454404',
                          'V80859442',
                          'V93792811',
                          'V96477375',
                          'V95303388',
                          'V13118913',
                          'V63718987',
                          'V40187516',
                          'V91650578',
                          'V88951027',
                          'V60588687',
                          'V65151597',
                          'V67227861',
                          'V95716528',
                          'V79373814',
                          'V51260822',
                          'V57289474',
                          'V50172643',
                          'V91153842',
                          'V42543773',
                          'V37476478',
                          'V74716785',
                          'V83246232',
                          'V44528201',
                          'V55554270',
                          'V62957659',
                          'V57970348',
                          'V88015816',
                          'V80940729',
                          'V98960990',
                          'V36949349',
                          'V28832264',
                          'V66101901',
                          'V77490001',
                          'V97747048',
                          'V93472820',
                          'V61452885',
                          'V96456682',
                          'V24028633',
                          'V92377693',
                          'V44755417',
                          'V66928004',
                          'V38168774',
                          'V89758113',
                          'V58209551',
                          'V50960500',
                          'V35707117',
                          'V88012450',
                          'V27443820',
                          'V47009382',
                          'V83125056',
                          'V97933978',
                          'V17318574',
                          'V99093005',
                          'V71718058',
                          'V59870749',
                          'V78612256',
                          'V46970013',
                          'V24201065',
                          'V10545403',
                          'V46698407',
                          'V17876538',
                          'V32720407',
                          'V19254866',
                          'V97172273',
                          'V59160764',
                          'V27575597',
                          'V40790540',
                          'V95859609',
                          'V52007155',
                          'V35162689',
                          'V60308216',
                          'V11104505',
                          'V16327804',
                          'V55224810',
                          'V56718880',
                          'V36153163',
                          'V22164916',
                          'V50720722',
                          'V87694927',
                          'V51138236',
                          'V88182971',
                          'V61692389',
                          'V97889737',
                          'V49479737',
                          'V91923385',
                          'V93233183',
                          'V27623410',
                          'V38453110',
                          'V13282018',
                          'V20848276',
                          'V56456445',
                          'V35518891',
                          'V39414926',
                          'V80211316',
                          'V99533369',
                          'V10693725',
                          'V62774450',
                          'V73726273',
                          'V24342827',
                          'V92299092',
                          'V85174160',
                          'V93304459',
                          'V47836600',
                          'V41374838',
                          'V78021793',
                          'V59054623',
                          'V57890617',
                          'V70382321',
                          'V28797990',
                          'V28500236',
                          'V94907497',
                          'V50859780',
                          'V22191825',
                          'V75405938',
                          'V38248033',
                          'V45498796',
                          'V88096585',
                          'V15698626',
                          'V54647811',
                          'V66096503',
                          'V64604086',
                          'V33815363',
                          'V75720828',
                          'V39024348',
                          'V90987050',
                          'V52183348'
    )
;


SELECT c.creator , c.modifier, count(DISTINCT ctr.outbound_id)
FROM public.invoice i
         JOIN customer c
              ON c.id = i.customer_id
         JOIN contract ctr
              ON i.contract_id = ctr.id
         JOIN payment p
              ON p.invoice_id = i.id
WHERE 1=1
  AND c.creator = 'urn:vimcar::service/new-user-checkout'
  AND c.modifier = 'urn:vimcar::service/new-user-checkout'
  AND ctr.outbound_id NOT IN (
                          'V17665452',
                          'V30026123',
                          'V48536203',
                          'V44999343',
                          'V71616413',
                          'V32509229',
                          'V59036640',
                          'V32228945',
                          'V31625628',
                          'V92279092',
                          'V71633441',
                          'V40781258',
                          'V36797271',
                          'V89301075',
                          'V54232911',
                          'V95631569',
                          'V20678740',
                          'V68960145',
                          'V40085469',
                          'V58454996',
                          'V65630617',
                          'V27667110',
                          'V22736785',
                          'V70950827',
                          'V32543756',
                          'V60535717',
                          'V11130128',
                          'V81501940',
                          'V69420303',
                          'V78219763',
                          'V68988917',
                          'V63211766',
                          'V37941707',
                          'V95623034',
                          'V75912969',
                          'V73338390',
                          'V12595330',
                          'V95644986',
                          'V33287344',
                          'V19404956',
                          'V98065300',
                          'V29965353',
                          'V67360008',
                          'V55223151',
                          'V75106071',
                          'V48953653',
                          'V10004020',
                          'V40551651',
                          'V67245360',
                          'V71289183',
                          'V21226773',
                          'V61184995',
                          'V85832149',
                          'V43256018',
                          'V29494430',
                          'V40102665',
                          'V26861450',
                          'V84985002',
                          'V78726006',
                          'V57751412',
                          'V17968719',
                          'V84112034',
                          'V69765902',
                          'V38995853',
                          'V48825173',
                          'V73250031',
                          'V99861367',
                          'V55228127',
                          'V21356007',
                          'V53014833',
                          'V42261242',
                          'V76595372',
                          'V33729854',
                          'V49888004',
                          'V76180178',
                          'V67289002',
                          'V71512745',
                          'V86409334',
                          'V74841744',
                          'V76417200',
                          'V78502622',
                          'V52941288',
                          'V87798887',
                          'V29221980',
                          'V57509436',
                          'V51520286',
                          'V50593064',
                          'V91979515',
                          'V51704368',
                          'V51876914',
                          'V97242339',
                          'V65473267',
                          'V27733642',
                          'V91523963',
                          'V29328309',
                          'V47817633',
                          'V78582087',
                          'V77426919',
                          'V69659502',
                          'V15386254',
                          'V54143521',
                          'V19641551',
                          'V16967737',
                          'V69122249',
                          'V52440228',
                          'V79836645',
                          'V18047958',
                          'V44098209',
                          'V89283874',
                          'V77300575',
                          'V24223530',
                          'V86210185',
                          'V26496820',
                          'V99223959',
                          'V60619629',
                          'V28377805',
                          'V66904027',
                          'V74110779',
                          'V91105163',
                          'V59961693',
                          'V51078114',
                          'V55219439',
                          'V15481914',
                          'V37558868',
                          'V54531297',
                          'V44287434',
                          'V97731300',
                          'V16161200',
                          'V55344252',
                          'V57988775',
                          'V64181472',
                          'V27400152',
                          'V74091622',
                          'V36803414',
                          'V89529236',
                          'V13920968',
                          'V80343436',
                          'V48486199',
                          'V76318505',
                          'V41246295',
                          'V90373254',
                          'V19233109',
                          'V37913077',
                          'V42205273',
                          'V99211060',
                          'V22854730',
                          'V22387321',
                          'V21746555',
                          'V20925433',
                          'V32316186',
                          'V15140043',
                          'V42143382',
                          'V53711567',
                          'V67257456',
                          'V94882698',
                          'V70989286',
                          'V21254325',
                          'V62798404',
                          'V31380031',
                          'V80608998',
                          'V72599225',
                          'V69098461',
                          'V84497818',
                          'V63689248',
                          'V48823901',
                          'V27836787',
                          'V60005062',
                          'V20094710',
                          'V61872151',
                          'V39957239',
                          'V58148720',
                          'V99638556',
                          'V79362595',
                          'V31349016',
                          'V83309380',
                          'V62309154',
                          'V58988863',
                          'V76342651',
                          'V46535566',
                          'V32628390',
                          'V41921353',
                          'V95603952',
                          'V71437382',
                          'V14512221',
                          'V22057002',
                          'V55121766',
                          'V34379046',
                          'V79078988',
                          'V64193267',
                          'V44030013',
                          'V41139365',
                          'V91739055',
                          'V93839097',
                          'V52118630',
                          'V48972435',
                          'V39002137',
                          'V47922161',
                          'V96387893',
                          'V39853159',
                          'V37044774',
                          'V81420034',
                          'V80572087',
                          'V18024954',
                          'V99791967',
                          'V33658753',
                          'V69591311',
                          'V21059693',
                          'V30033007',
                          'V71635256',
                          'V84586455',
                          'V34240313',
                          'V10047323',
                          'V38913441',
                          'V39929552',
                          'V59397148',
                          'V44044321',
                          'V91778977',
                          'V25950106',
                          'V72928703',
                          'V85361553',
                          'V46970225',
                          'V61571721',
                          'V33785194',
                          'V14045924',
                          'V17867392',
                          'V80786644',
                          'V57854061',
                          'V14983949',
                          'V99639546',
                          'V21763794',
                          'V20813496',
                          'V11127915',
                          'V15770539',
                          'V63878597',
                          'V42617954',
                          'V70589541',
                          'V91953817',
                          'V99672271',
                          'V13696761',
                          'V46937875',
                          'V32904806',
                          'V45270925',
                          'V73224229',
                          'V41452786',
                          'V50585571',
                          'V53440359',
                          'V56730743',
                          'V50859507',
                          'V20837348',
                          'V32528880',
                          'V27516870',
                          'V57706132',
                          'V89639400',
                          'V12844619',
                          'V22698225',
                          'V59814680',
                          'V13815119',
                          'V64874589',
                          'V63595603',
                          'V49276407',
                          'V14354755',
                          'V52942328',
                          'V16873080',
                          'V90993926',
                          'V97599695',
                          'V23459253',
                          'V24829754',
                          'V32131526',
                          'V77233648',
                          'V53035852',
                          'V68162262',
                          'V57507647',
                          'V54235532',
                          'V61634222',
                          'V87227873',
                          'V38095603',
                          'V97578239',
                          'V63172090',
                          'V28417210',
                          'V82873041',
                          'V11367676',
                          'V79013744',
                          'V70595294',
                          'V89726690',
                          'V63708962',
                          'V21444153',
                          'V12245886',
                          'V65762453',
                          'V68165028',
                          'V64847131',
                          'V95181884',
                          'V18198118',
                          'V20425530',
                          'V60995740',
                          'V18774798',
                          'V12702217',
                          'V46381516',
                          'V19454404',
                          'V80859442',
                          'V93792811',
                          'V96477375',
                          'V95303388',
                          'V13118913',
                          'V63718987',
                          'V40187516',
                          'V91650578',
                          'V88951027',
                          'V60588687',
                          'V65151597',
                          'V67227861',
                          'V95716528',
                          'V79373814',
                          'V51260822',
                          'V57289474',
                          'V50172643',
                          'V91153842',
                          'V42543773',
                          'V37476478',
                          'V74716785',
                          'V83246232',
                          'V44528201',
                          'V55554270',
                          'V62957659',
                          'V57970348',
                          'V88015816',
                          'V80940729',
                          'V98960990',
                          'V36949349',
                          'V28832264',
                          'V66101901',
                          'V77490001',
                          'V97747048',
                          'V93472820',
                          'V61452885',
                          'V96456682',
                          'V24028633',
                          'V92377693',
                          'V44755417',
                          'V66928004',
                          'V38168774',
                          'V89758113',
                          'V58209551',
                          'V50960500',
                          'V35707117',
                          'V88012450',
                          'V27443820',
                          'V47009382',
                          'V83125056',
                          'V97933978',
                          'V17318574',
                          'V99093005',
                          'V71718058',
                          'V59870749',
                          'V78612256',
                          'V46970013',
                          'V24201065',
                          'V10545403',
                          'V46698407',
                          'V17876538',
                          'V32720407',
                          'V19254866',
                          'V97172273',
                          'V59160764',
                          'V27575597',
                          'V40790540',
                          'V95859609',
                          'V52007155',
                          'V35162689',
                          'V60308216',
                          'V11104505',
                          'V16327804',
                          'V55224810',
                          'V56718880',
                          'V36153163',
                          'V22164916',
                          'V50720722',
                          'V87694927',
                          'V51138236',
                          'V88182971',
                          'V61692389',
                          'V97889737',
                          'V49479737',
                          'V91923385',
                          'V93233183',
                          'V27623410',
                          'V38453110',
                          'V13282018',
                          'V20848276',
                          'V56456445',
                          'V35518891',
                          'V39414926',
                          'V80211316',
                          'V99533369',
                          'V10693725',
                          'V62774450',
                          'V73726273',
                          'V24342827',
                          'V92299092',
                          'V85174160',
                          'V93304459',
                          'V47836600',
                          'V41374838',
                          'V78021793',
                          'V59054623',
                          'V57890617',
                          'V70382321',
                          'V28797990',
                          'V28500236',
                          'V94907497',
                          'V50859780',
                          'V22191825',
                          'V75405938',
                          'V38248033',
                          'V45498796',
                          'V88096585',
                          'V15698626',
                          'V54647811',
                          'V66096503',
                          'V64604086',
                          'V33815363',
                          'V75720828',
                          'V39024348',
                          'V90987050',
                          'V52183348'
    )
GROUP BY c.creator, c.modifier;


SELECT *
FROM public.invoice i
         JOIN customer c
              ON c.id = i.customer_id
         JOIN contract ctr
              ON i.contract_id = ctr.id
         JOIN payment p
              ON p.invoice_id = i.id
WHERE 1=1
  AND c.creator = 'urn:vimcar::service/new-user-checkout'
  AND c.modifier = 'urn:vimcar::service/new-user-checkout'
  AND ctr.outbound_id NOT IN (
                              'V17665452',
                              'V30026123',
                              'V48536203',
                              'V44999343',
                              'V71616413',
                              'V32509229',
                              'V59036640',
                              'V32228945',
                              'V31625628',
                              'V92279092',
                              'V71633441',
                              'V40781258',
                              'V36797271',
                              'V89301075',
                              'V54232911',
                              'V95631569',
                              'V20678740',
                              'V68960145',
                              'V40085469',
                              'V58454996',
                              'V65630617',
                              'V27667110',
                              'V22736785',
                              'V70950827',
                              'V32543756',
                              'V60535717',
                              'V11130128',
                              'V81501940',
                              'V69420303',
                              'V78219763',
                              'V68988917',
                              'V63211766',
                              'V37941707',
                              'V95623034',
                              'V75912969',
                              'V73338390',
                              'V12595330',
                              'V95644986',
                              'V33287344',
                              'V19404956',
                              'V98065300',
                              'V29965353',
                              'V67360008',
                              'V55223151',
                              'V75106071',
                              'V48953653',
                              'V10004020',
                              'V40551651',
                              'V67245360',
                              'V71289183',
                              'V21226773',
                              'V61184995',
                              'V85832149',
                              'V43256018',
                              'V29494430',
                              'V40102665',
                              'V26861450',
                              'V84985002',
                              'V78726006',
                              'V57751412',
                              'V17968719',
                              'V84112034',
                              'V69765902',
                              'V38995853',
                              'V48825173',
                              'V73250031',
                              'V99861367',
                              'V55228127',
                              'V21356007',
                              'V53014833',
                              'V42261242',
                              'V76595372',
                              'V33729854',
                              'V49888004',
                              'V76180178',
                              'V67289002',
                              'V71512745',
                              'V86409334',
                              'V74841744',
                              'V76417200',
                              'V78502622',
                              'V52941288',
                              'V87798887',
                              'V29221980',
                              'V57509436',
                              'V51520286',
                              'V50593064',
                              'V91979515',
                              'V51704368',
                              'V51876914',
                              'V97242339',
                              'V65473267',
                              'V27733642',
                              'V91523963',
                              'V29328309',
                              'V47817633',
                              'V78582087',
                              'V77426919',
                              'V69659502',
                              'V15386254',
                              'V54143521',
                              'V19641551',
                              'V16967737',
                              'V69122249',
                              'V52440228',
                              'V79836645',
                              'V18047958',
                              'V44098209',
                              'V89283874',
                              'V77300575',
                              'V24223530',
                              'V86210185',
                              'V26496820',
                              'V99223959',
                              'V60619629',
                              'V28377805',
                              'V66904027',
                              'V74110779',
                              'V91105163',
                              'V59961693',
                              'V51078114',
                              'V55219439',
                              'V15481914',
                              'V37558868',
                              'V54531297',
                              'V44287434',
                              'V97731300',
                              'V16161200',
                              'V55344252',
                              'V57988775',
                              'V64181472',
                              'V27400152',
                              'V74091622',
                              'V36803414',
                              'V89529236',
                              'V13920968',
                              'V80343436',
                              'V48486199',
                              'V76318505',
                              'V41246295',
                              'V90373254',
                              'V19233109',
                              'V37913077',
                              'V42205273',
                              'V99211060',
                              'V22854730',
                              'V22387321',
                              'V21746555',
                              'V20925433',
                              'V32316186',
                              'V15140043',
                              'V42143382',
                              'V53711567',
                              'V67257456',
                              'V94882698',
                              'V70989286',
                              'V21254325',
                              'V62798404',
                              'V31380031',
                              'V80608998',
                              'V72599225',
                              'V69098461',
                              'V84497818',
                              'V63689248',
                              'V48823901',
                              'V27836787',
                              'V60005062',
                              'V20094710',
                              'V61872151',
                              'V39957239',
                              'V58148720',
                              'V99638556',
                              'V79362595',
                              'V31349016',
                              'V83309380',
                              'V62309154',
                              'V58988863',
                              'V76342651',
                              'V46535566',
                              'V32628390',
                              'V41921353',
                              'V95603952',
                              'V71437382',
                              'V14512221',
                              'V22057002',
                              'V55121766',
                              'V34379046',
                              'V79078988',
                              'V64193267',
                              'V44030013',
                              'V41139365',
                              'V91739055',
                              'V93839097',
                              'V52118630',
                              'V48972435',
                              'V39002137',
                              'V47922161',
                              'V96387893',
                              'V39853159',
                              'V37044774',
                              'V81420034',
                              'V80572087',
                              'V18024954',
                              'V99791967',
                              'V33658753',
                              'V69591311',
                              'V21059693',
                              'V30033007',
                              'V71635256',
                              'V84586455',
                              'V34240313',
                              'V10047323',
                              'V38913441',
                              'V39929552',
                              'V59397148',
                              'V44044321',
                              'V91778977',
                              'V25950106',
                              'V72928703',
                              'V85361553',
                              'V46970225',
                              'V61571721',
                              'V33785194',
                              'V14045924',
                              'V17867392',
                              'V80786644',
                              'V57854061',
                              'V14983949',
                              'V99639546',
                              'V21763794',
                              'V20813496',
                              'V11127915',
                              'V15770539',
                              'V63878597',
                              'V42617954',
                              'V70589541',
                              'V91953817',
                              'V99672271',
                              'V13696761',
                              'V46937875',
                              'V32904806',
                              'V45270925',
                              'V73224229',
                              'V41452786',
                              'V50585571',
                              'V53440359',
                              'V56730743',
                              'V50859507',
                              'V20837348',
                              'V32528880',
                              'V27516870',
                              'V57706132',
                              'V89639400',
                              'V12844619',
                              'V22698225',
                              'V59814680',
                              'V13815119',
                              'V64874589',
                              'V63595603',
                              'V49276407',
                              'V14354755',
                              'V52942328',
                              'V16873080',
                              'V90993926',
                              'V97599695',
                              'V23459253',
                              'V24829754',
                              'V32131526',
                              'V77233648',
                              'V53035852',
                              'V68162262',
                              'V57507647',
                              'V54235532',
                              'V61634222',
                              'V87227873',
                              'V38095603',
                              'V97578239',
                              'V63172090',
                              'V28417210',
                              'V82873041',
                              'V11367676',
                              'V79013744',
                              'V70595294',
                              'V89726690',
                              'V63708962',
                              'V21444153',
                              'V12245886',
                              'V65762453',
                              'V68165028',
                              'V64847131',
                              'V95181884',
                              'V18198118',
                              'V20425530',
                              'V60995740',
                              'V18774798',
                              'V12702217',
                              'V46381516',
                              'V19454404',
                              'V80859442',
                              'V93792811',
                              'V96477375',
                              'V95303388',
                              'V13118913',
                              'V63718987',
                              'V40187516',
                              'V91650578',
                              'V88951027',
                              'V60588687',
                              'V65151597',
                              'V67227861',
                              'V95716528',
                              'V79373814',
                              'V51260822',
                              'V57289474',
                              'V50172643',
                              'V91153842',
                              'V42543773',
                              'V37476478',
                              'V74716785',
                              'V83246232',
                              'V44528201',
                              'V55554270',
                              'V62957659',
                              'V57970348',
                              'V88015816',
                              'V80940729',
                              'V98960990',
                              'V36949349',
                              'V28832264',
                              'V66101901',
                              'V77490001',
                              'V97747048',
                              'V93472820',
                              'V61452885',
                              'V96456682',
                              'V24028633',
                              'V92377693',
                              'V44755417',
                              'V66928004',
                              'V38168774',
                              'V89758113',
                              'V58209551',
                              'V50960500',
                              'V35707117',
                              'V88012450',
                              'V27443820',
                              'V47009382',
                              'V83125056',
                              'V97933978',
                              'V17318574',
                              'V99093005',
                              'V71718058',
                              'V59870749',
                              'V78612256',
                              'V46970013',
                              'V24201065',
                              'V10545403',
                              'V46698407',
                              'V17876538',
                              'V32720407',
                              'V19254866',
                              'V97172273',
                              'V59160764',
                              'V27575597',
                              'V40790540',
                              'V95859609',
                              'V52007155',
                              'V35162689',
                              'V60308216',
                              'V11104505',
                              'V16327804',
                              'V55224810',
                              'V56718880',
                              'V36153163',
                              'V22164916',
                              'V50720722',
                              'V87694927',
                              'V51138236',
                              'V88182971',
                              'V61692389',
                              'V97889737',
                              'V49479737',
                              'V91923385',
                              'V93233183',
                              'V27623410',
                              'V38453110',
                              'V13282018',
                              'V20848276',
                              'V56456445',
                              'V35518891',
                              'V39414926',
                              'V80211316',
                              'V99533369',
                              'V10693725',
                              'V62774450',
                              'V73726273',
                              'V24342827',
                              'V92299092',
                              'V85174160',
                              'V93304459',
                              'V47836600',
                              'V41374838',
                              'V78021793',
                              'V59054623',
                              'V57890617',
                              'V70382321',
                              'V28797990',
                              'V28500236',
                              'V94907497',
                              'V50859780',
                              'V22191825',
                              'V75405938',
                              'V38248033',
                              'V45498796',
                              'V88096585',
                              'V15698626',
                              'V54647811',
                              'V66096503',
                              'V64604086',
                              'V33815363',
                              'V75720828',
                              'V39024348',
                              'V90987050',
                              'V52183348'
    )
;

SELECT i.outbound_id AS invoice_id
, i.creator
, i.modifier
, c.outbound_id AS customer_id
, c.creator
, c.modifier
, ctr.outbound_id AS contract_id
, ctr.creator
, ctr.modifier
, p.id AS payment_id
, p.creator
, p.modifier
, p.status
, p.authorized
FROM public.invoice i
         JOIN customer c
              ON c.id = i.customer_id
         JOIN contract ctr
              ON i.contract_id = ctr.id
         JOIN payment p
              ON p.invoice_id = i.id
WHERE 1=1
  AND ctr.outbound_id = 'V10170000'
  AND c.creator = 'urn:vimcar::service/new-user-checkout'
  AND c.modifier = 'urn:vimcar::service/new-user-checkout'
  AND ctr.outbound_id NOT IN (
                              'V17665452',
                              'V30026123',
                              'V48536203',
                              'V44999343',
                              'V71616413',
                              'V32509229',
                              'V59036640',
                              'V32228945',
                              'V31625628',
                              'V92279092',
                              'V71633441',
                              'V40781258',
                              'V36797271',
                              'V89301075',
                              'V54232911',
                              'V95631569',
                              'V20678740',
                              'V68960145',
                              'V40085469',
                              'V58454996',
                              'V65630617',
                              'V27667110',
                              'V22736785',
                              'V70950827',
                              'V32543756',
                              'V60535717',
                              'V11130128',
                              'V81501940',
                              'V69420303',
                              'V78219763',
                              'V68988917',
                              'V63211766',
                              'V37941707',
                              'V95623034',
                              'V75912969',
                              'V73338390',
                              'V12595330',
                              'V95644986',
                              'V33287344',
                              'V19404956',
                              'V98065300',
                              'V29965353',
                              'V67360008',
                              'V55223151',
                              'V75106071',
                              'V48953653',
                              'V10004020',
                              'V40551651',
                              'V67245360',
                              'V71289183',
                              'V21226773',
                              'V61184995',
                              'V85832149',
                              'V43256018',
                              'V29494430',
                              'V40102665',
                              'V26861450',
                              'V84985002',
                              'V78726006',
                              'V57751412',
                              'V17968719',
                              'V84112034',
                              'V69765902',
                              'V38995853',
                              'V48825173',
                              'V73250031',
                              'V99861367',
                              'V55228127',
                              'V21356007',
                              'V53014833',
                              'V42261242',
                              'V76595372',
                              'V33729854',
                              'V49888004',
                              'V76180178',
                              'V67289002',
                              'V71512745',
                              'V86409334',
                              'V74841744',
                              'V76417200',
                              'V78502622',
                              'V52941288',
                              'V87798887',
                              'V29221980',
                              'V57509436',
                              'V51520286',
                              'V50593064',
                              'V91979515',
                              'V51704368',
                              'V51876914',
                              'V97242339',
                              'V65473267',
                              'V27733642',
                              'V91523963',
                              'V29328309',
                              'V47817633',
                              'V78582087',
                              'V77426919',
                              'V69659502',
                              'V15386254',
                              'V54143521',
                              'V19641551',
                              'V16967737',
                              'V69122249',
                              'V52440228',
                              'V79836645',
                              'V18047958',
                              'V44098209',
                              'V89283874',
                              'V77300575',
                              'V24223530',
                              'V86210185',
                              'V26496820',
                              'V99223959',
                              'V60619629',
                              'V28377805',
                              'V66904027',
                              'V74110779',
                              'V91105163',
                              'V59961693',
                              'V51078114',
                              'V55219439',
                              'V15481914',
                              'V37558868',
                              'V54531297',
                              'V44287434',
                              'V97731300',
                              'V16161200',
                              'V55344252',
                              'V57988775',
                              'V64181472',
                              'V27400152',
                              'V74091622',
                              'V36803414',
                              'V89529236',
                              'V13920968',
                              'V80343436',
                              'V48486199',
                              'V76318505',
                              'V41246295',
                              'V90373254',
                              'V19233109',
                              'V37913077',
                              'V42205273',
                              'V99211060',
                              'V22854730',
                              'V22387321',
                              'V21746555',
                              'V20925433',
                              'V32316186',
                              'V15140043',
                              'V42143382',
                              'V53711567',
                              'V67257456',
                              'V94882698',
                              'V70989286',
                              'V21254325',
                              'V62798404',
                              'V31380031',
                              'V80608998',
                              'V72599225',
                              'V69098461',
                              'V84497818',
                              'V63689248',
                              'V48823901',
                              'V27836787',
                              'V60005062',
                              'V20094710',
                              'V61872151',
                              'V39957239',
                              'V58148720',
                              'V99638556',
                              'V79362595',
                              'V31349016',
                              'V83309380',
                              'V62309154',
                              'V58988863',
                              'V76342651',
                              'V46535566',
                              'V32628390',
                              'V41921353',
                              'V95603952',
                              'V71437382',
                              'V14512221',
                              'V22057002',
                              'V55121766',
                              'V34379046',
                              'V79078988',
                              'V64193267',
                              'V44030013',
                              'V41139365',
                              'V91739055',
                              'V93839097',
                              'V52118630',
                              'V48972435',
                              'V39002137',
                              'V47922161',
                              'V96387893',
                              'V39853159',
                              'V37044774',
                              'V81420034',
                              'V80572087',
                              'V18024954',
                              'V99791967',
                              'V33658753',
                              'V69591311',
                              'V21059693',
                              'V30033007',
                              'V71635256',
                              'V84586455',
                              'V34240313',
                              'V10047323',
                              'V38913441',
                              'V39929552',
                              'V59397148',
                              'V44044321',
                              'V91778977',
                              'V25950106',
                              'V72928703',
                              'V85361553',
                              'V46970225',
                              'V61571721',
                              'V33785194',
                              'V14045924',
                              'V17867392',
                              'V80786644',
                              'V57854061',
                              'V14983949',
                              'V99639546',
                              'V21763794',
                              'V20813496',
                              'V11127915',
                              'V15770539',
                              'V63878597',
                              'V42617954',
                              'V70589541',
                              'V91953817',
                              'V99672271',
                              'V13696761',
                              'V46937875',
                              'V32904806',
                              'V45270925',
                              'V73224229',
                              'V41452786',
                              'V50585571',
                              'V53440359',
                              'V56730743',
                              'V50859507',
                              'V20837348',
                              'V32528880',
                              'V27516870',
                              'V57706132',
                              'V89639400',
                              'V12844619',
                              'V22698225',
                              'V59814680',
                              'V13815119',
                              'V64874589',
                              'V63595603',
                              'V49276407',
                              'V14354755',
                              'V52942328',
                              'V16873080',
                              'V90993926',
                              'V97599695',
                              'V23459253',
                              'V24829754',
                              'V32131526',
                              'V77233648',
                              'V53035852',
                              'V68162262',
                              'V57507647',
                              'V54235532',
                              'V61634222',
                              'V87227873',
                              'V38095603',
                              'V97578239',
                              'V63172090',
                              'V28417210',
                              'V82873041',
                              'V11367676',
                              'V79013744',
                              'V70595294',
                              'V89726690',
                              'V63708962',
                              'V21444153',
                              'V12245886',
                              'V65762453',
                              'V68165028',
                              'V64847131',
                              'V95181884',
                              'V18198118',
                              'V20425530',
                              'V60995740',
                              'V18774798',
                              'V12702217',
                              'V46381516',
                              'V19454404',
                              'V80859442',
                              'V93792811',
                              'V96477375',
                              'V95303388',
                              'V13118913',
                              'V63718987',
                              'V40187516',
                              'V91650578',
                              'V88951027',
                              'V60588687',
                              'V65151597',
                              'V67227861',
                              'V95716528',
                              'V79373814',
                              'V51260822',
                              'V57289474',
                              'V50172643',
                              'V91153842',
                              'V42543773',
                              'V37476478',
                              'V74716785',
                              'V83246232',
                              'V44528201',
                              'V55554270',
                              'V62957659',
                              'V57970348',
                              'V88015816',
                              'V80940729',
                              'V98960990',
                              'V36949349',
                              'V28832264',
                              'V66101901',
                              'V77490001',
                              'V97747048',
                              'V93472820',
                              'V61452885',
                              'V96456682',
                              'V24028633',
                              'V92377693',
                              'V44755417',
                              'V66928004',
                              'V38168774',
                              'V89758113',
                              'V58209551',
                              'V50960500',
                              'V35707117',
                              'V88012450',
                              'V27443820',
                              'V47009382',
                              'V83125056',
                              'V97933978',
                              'V17318574',
                              'V99093005',
                              'V71718058',
                              'V59870749',
                              'V78612256',
                              'V46970013',
                              'V24201065',
                              'V10545403',
                              'V46698407',
                              'V17876538',
                              'V32720407',
                              'V19254866',
                              'V97172273',
                              'V59160764',
                              'V27575597',
                              'V40790540',
                              'V95859609',
                              'V52007155',
                              'V35162689',
                              'V60308216',
                              'V11104505',
                              'V16327804',
                              'V55224810',
                              'V56718880',
                              'V36153163',
                              'V22164916',
                              'V50720722',
                              'V87694927',
                              'V51138236',
                              'V88182971',
                              'V61692389',
                              'V97889737',
                              'V49479737',
                              'V91923385',
                              'V93233183',
                              'V27623410',
                              'V38453110',
                              'V13282018',
                              'V20848276',
                              'V56456445',
                              'V35518891',
                              'V39414926',
                              'V80211316',
                              'V99533369',
                              'V10693725',
                              'V62774450',
                              'V73726273',
                              'V24342827',
                              'V92299092',
                              'V85174160',
                              'V93304459',
                              'V47836600',
                              'V41374838',
                              'V78021793',
                              'V59054623',
                              'V57890617',
                              'V70382321',
                              'V28797990',
                              'V28500236',
                              'V94907497',
                              'V50859780',
                              'V22191825',
                              'V75405938',
                              'V38248033',
                              'V45498796',
                              'V88096585',
                              'V15698626',
                              'V54647811',
                              'V66096503',
                              'V64604086',
                              'V33815363',
                              'V75720828',
                              'V39024348',
                              'V90987050',
                              'V52183348'
    )
;

WITH cte_raw AS (
SELECT DISTINCT i.outbound_id AS invoice_id
     , i.created AS invoice_created_ts
     , CASE
         WHEN (i.creator = 'urn:vimcar::service/new-user-checkout' AND i.modifier = 'urn:vimcar::service/new-user-checkout')
               OR (i.creator = 'urn:vimcar::service/new-user-checkout' AND i.modifier LIKE 'urn:vimcar:com.vimcar:user%' AND p.status <> 'authorised')
             THEN TRUE
             END AS is_ghost_invoice
     , i.creator AS i_creator
     , i.modifier AS i_modifier
     , c.outbound_id AS customer_id
     , c.creator AS cus_creator
     , c.modifier AS cus_modifier
     , ctr.outbound_id AS contract_id
     , ctr.creator AS ctr_creator
     , ctr.modifier AS ctr_modifier
     , true = ANY(ARRAY_AGG(CASE WHEN authorized IS NOT NULL THEN TRUE END) OVER (PARTITION BY ctr.outbound_id)) AS contract_has_authorised_payment
     , true = ANY(ARRAY_AGG(CASE
                            WHEN (i.creator = 'urn:vimcar::service/new-user-checkout' AND i.modifier = 'urn:vimcar::service/new-user-checkout')
                                OR (i.creator = 'urn:vimcar::service/new-user-checkout' AND i.modifier LIKE 'urn:vimcar:com.vimcar:user%' AND p.status <> 'authorised')
                                THEN TRUE END) OVER (PARTITION BY ctr.outbound_id)) AS contract_has_ghost_invoice
FROM public.invoice i
         JOIN customer c
              ON c.id = i.customer_id
         JOIN contract ctr
              ON i.contract_id = ctr.id
         JOIN payment p
              ON p.invoice_id = i.id
WHERE 1=1
-- AND ctr.outbound_id IN ('V12595330', 'V96537948')
--     AND ctr.outbound_id = 'V12595330' -- is ghost contract as
--     AND ctr.outbound_id = 'V96537948' -- is not as ghost as had one legit invoice in the past
--   AND ctr.outbound_id IN ('V11130128', 'V40102665') -- contracts had authorised payment but also a ghost invoice in the past
  AND c.creator = 'urn:vimcar::service/new-user-checkout'
  AND c.modifier = 'urn:vimcar::service/new-user-checkout'
  AND ctr.creator = 'urn:vimcar::service/new-user-checkout'
  AND ctr.modifier IN ('urn:vimcar::application/customers',
                       'urn:vimcar::service/new-user-checkout',
                        'urn:vimcar:com.vimcar:service/contract-renewal')
)
, cte_calc_1 AS (
    SELECT *
--     If a contract has only two invoices and the first one was a ghost invoice then the second invoice must be a renewal of a ghost invoice :
    , CASE
         WHEN count(contract_id) OVER (PARTITION BY contract_id) = 2
             AND contract_has_ghost_invoice IS TRUE
             AND i_creator = 'urn:vimcar:com.vimcar:service/contract-renewal'
             THEN TRUE
        END AS invoice_is_renewal_of_ghost_invoice
    FROM cte_raw
)
, cte_calc_2 AS (SELECT *
                      , TRUE = ANY (ARRAY_AGG(invoice_is_renewal_of_ghost_invoice) OVER (PARTITION BY contract_id)) AS contract_has_renewal_of_ghost_invoice

                 FROM cte_calc_1)
SELECT *
FROM cte_calc_2
WHERE contract_has_authorised_payment IS NOT TRUE
        OR contract_has_renewal_of_ghost_invoice IS TRUE
;


SELECT *
FROM cte_raw
WHERE 1=1
--     AND contract_had_authorised_payment IS NOT TRUE
        AND (contract_had_ghost_invoice IS TRUE
            AND contract_had_authorised_payment IS TRUE)
;




SELECT i.outbound_id AS invoice_id
     , i.creator AS i_creator
     , i.modifier AS i_modifier
     , c.outbound_id AS customer_id
     , c.creator AS cus_creator
     , c.modifier AS cus_modifier
     , ctr.outbound_id AS contract_id
     , ctr.creator AS ctr_creator
     , ctr.modifier AS ctr_modifier
     , p.id AS payment_id
     , p.creator AS p_creator
     , p.modifier AS p_modifier
     , p.status AS p_status
--      , p.authorized
     , true = ANY(ARRAY_AGG(CASE WHEN authorized IS NOT NULL THEN TRUE END) OVER (PARTITION BY ctr.outbound_id)) AS contract_had_authorised_payment
FROM public.invoice i
         JOIN customer c
              ON c.id = i.customer_id
         JOIN contract ctr
              ON i.contract_id = ctr.id
         JOIN payment p
              ON p.invoice_id = i.id
WHERE 1=1
  AND ctr.outbound_id IN (
                              'V17665452',
                              'V30026123',
                              'V48536203',
                              'V44999343',
                              'V71616413',
                              'V32509229',
                              'V59036640',
                              'V32228945',
                              'V31625628',
                              'V92279092',
                              'V71633441',
                              'V40781258',
                              'V36797271',
                              'V89301075',
                              'V54232911',
                              'V95631569',
                              'V20678740',
                              'V68960145',
                              'V40085469',
                              'V58454996',
                              'V65630617',
                              'V27667110',
                              'V22736785',
                              'V70950827',
                              'V32543756',
                              'V60535717',
                              'V11130128',
                              'V81501940',
                              'V69420303',
                              'V78219763',
                              'V68988917',
                              'V63211766',
                              'V37941707',
                              'V95623034',
                              'V75912969',
                              'V73338390',
                              'V12595330',
                              'V95644986',
                              'V33287344',
                              'V19404956',
                              'V98065300',
                              'V29965353',
                              'V67360008',
                              'V55223151',
                              'V75106071',
                              'V48953653',
                              'V10004020',
                              'V40551651',
                              'V67245360',
                              'V71289183',
                              'V21226773',
                              'V61184995',
                              'V85832149',
                              'V43256018',
                              'V29494430',
                              'V40102665',
                              'V26861450',
                              'V84985002',
                              'V78726006',
                              'V57751412',
                              'V17968719',
                              'V84112034',
                              'V69765902',
                              'V38995853',
                              'V48825173',
                              'V73250031',
                              'V99861367',
                              'V55228127',
                              'V21356007',
                              'V53014833',
                              'V42261242',
                              'V76595372',
                              'V33729854',
                              'V49888004',
                              'V76180178',
                              'V67289002',
                              'V71512745',
                              'V86409334',
                              'V74841744',
                              'V76417200',
                              'V78502622',
                              'V52941288',
                              'V87798887',
                              'V29221980',
                              'V57509436',
                              'V51520286',
                              'V50593064',
                              'V91979515',
                              'V51704368',
                              'V51876914',
                              'V97242339',
                              'V65473267',
                              'V27733642',
                              'V91523963',
                              'V29328309',
                              'V47817633',
                              'V78582087',
                              'V77426919',
                              'V69659502',
                              'V15386254',
                              'V54143521',
                              'V19641551',
                              'V16967737',
                              'V69122249',
                              'V52440228',
                              'V79836645',
                              'V18047958',
                              'V44098209',
                              'V89283874',
                              'V77300575',
                              'V24223530',
                              'V86210185',
                              'V26496820',
                              'V99223959',
                              'V60619629',
                              'V28377805',
                              'V66904027',
                              'V74110779',
                              'V91105163',
                              'V59961693',
                              'V51078114',
                              'V55219439',
                              'V15481914',
                              'V37558868',
                              'V54531297',
                              'V44287434',
                              'V97731300',
                              'V16161200',
                              'V55344252',
                              'V57988775',
                              'V64181472',
                              'V27400152',
                              'V74091622',
                              'V36803414',
                              'V89529236',
                              'V13920968',
                              'V80343436',
                              'V48486199',
                              'V76318505',
                              'V41246295',
                              'V90373254',
                              'V19233109',
                              'V37913077',
                              'V42205273',
                              'V99211060',
                              'V22854730',
                              'V22387321',
                              'V21746555',
                              'V20925433',
                              'V32316186',
                              'V15140043',
                              'V42143382',
                              'V53711567',
                              'V67257456',
                              'V94882698',
                              'V70989286',
                              'V21254325',
                              'V62798404',
                              'V31380031',
                              'V80608998',
                              'V72599225',
                              'V69098461',
                              'V84497818',
                              'V63689248',
                              'V48823901',
                              'V27836787',
                              'V60005062',
                              'V20094710',
                              'V61872151',
                              'V39957239',
                              'V58148720',
                              'V99638556',
                              'V79362595',
                              'V31349016',
                              'V83309380',
                              'V62309154',
                              'V58988863',
                              'V76342651',
                              'V46535566',
                              'V32628390',
                              'V41921353',
                              'V95603952',
                              'V71437382',
                              'V14512221',
                              'V22057002',
                              'V55121766',
                              'V34379046',
                              'V79078988',
                              'V64193267',
                              'V44030013',
                              'V41139365',
                              'V91739055',
                              'V93839097',
                              'V52118630',
                              'V48972435',
                              'V39002137',
                              'V47922161',
                              'V96387893',
                              'V39853159',
                              'V37044774',
                              'V81420034',
                              'V80572087',
                              'V18024954',
                              'V99791967',
                              'V33658753',
                              'V69591311',
                              'V21059693',
                              'V30033007',
                              'V71635256',
                              'V84586455',
                              'V34240313',
                              'V10047323',
                              'V38913441',
                              'V39929552',
                              'V59397148',
                              'V44044321',
                              'V91778977',
                              'V25950106',
                              'V72928703',
                              'V85361553',
                              'V46970225',
                              'V61571721',
                              'V33785194',
                              'V14045924',
                              'V17867392',
                              'V80786644',
                              'V57854061',
                              'V14983949',
                              'V99639546',
                              'V21763794',
                              'V20813496',
                              'V11127915',
                              'V15770539',
                              'V63878597',
                              'V42617954',
                              'V70589541',
                              'V91953817',
                              'V99672271',
                              'V13696761',
                              'V46937875',
                              'V32904806',
                              'V45270925',
                              'V73224229',
                              'V41452786',
                              'V50585571',
                              'V53440359',
                              'V56730743',
                              'V50859507',
                              'V20837348',
                              'V32528880',
                              'V27516870',
                              'V57706132',
                              'V89639400',
                              'V12844619',
                              'V22698225',
                              'V59814680',
                              'V13815119',
                              'V64874589',
                              'V63595603',
                              'V49276407',
                              'V14354755',
                              'V52942328',
                              'V16873080',
                              'V90993926',
                              'V97599695',
                              'V23459253',
                              'V24829754',
                              'V32131526',
                              'V77233648',
                              'V53035852',
                              'V68162262',
                              'V57507647',
                              'V54235532',
                              'V61634222',
                              'V87227873',
                              'V38095603',
                              'V97578239',
                              'V63172090',
                              'V28417210',
                              'V82873041',
                              'V11367676',
                              'V79013744',
                              'V70595294',
                              'V89726690',
                              'V63708962',
                              'V21444153',
                              'V12245886',
                              'V65762453',
                              'V68165028',
                              'V64847131',
                              'V95181884',
                              'V18198118',
                              'V20425530',
                              'V60995740',
                              'V18774798',
                              'V12702217',
                              'V46381516',
                              'V19454404',
                              'V80859442',
                              'V93792811',
                              'V96477375',
                              'V95303388',
                              'V13118913',
                              'V63718987',
                              'V40187516',
                              'V91650578',
                              'V88951027',
                              'V60588687',
                              'V65151597',
                              'V67227861',
                              'V95716528',
                              'V79373814',
                              'V51260822',
                              'V57289474',
                              'V50172643',
                              'V91153842',
                              'V42543773',
                              'V37476478',
                              'V74716785',
                              'V83246232',
                              'V44528201',
                              'V55554270',
                              'V62957659',
                              'V57970348',
                              'V88015816',
                              'V80940729',
                              'V98960990',
                              'V36949349',
                              'V28832264',
                              'V66101901',
                              'V77490001',
                              'V97747048',
                              'V93472820',
                              'V61452885',
                              'V96456682',
                              'V24028633',
                              'V92377693',
                              'V44755417',
                              'V66928004',
                              'V38168774',
                              'V89758113',
                              'V58209551',
                              'V50960500',
                              'V35707117',
                              'V88012450',
                              'V27443820',
                              'V47009382',
                              'V83125056',
                              'V97933978',
                              'V17318574',
                              'V99093005',
                              'V71718058',
                              'V59870749',
                              'V78612256',
                              'V46970013',
                              'V24201065',
                              'V10545403',
                              'V46698407',
                              'V17876538',
                              'V32720407',
                              'V19254866',
                              'V97172273',
                              'V59160764',
                              'V27575597',
                              'V40790540',
                              'V95859609',
                              'V52007155',
                              'V35162689',
                              'V60308216',
                              'V11104505',
                              'V16327804',
                              'V55224810',
                              'V56718880',
                              'V36153163',
                              'V22164916',
                              'V50720722',
                              'V87694927',
                              'V51138236',
                              'V88182971',
                              'V61692389',
                              'V97889737',
                              'V49479737',
                              'V91923385',
                              'V93233183',
                              'V27623410',
                              'V38453110',
                              'V13282018',
                              'V20848276',
                              'V56456445',
                              'V35518891',
                              'V39414926',
                              'V80211316',
                              'V99533369',
                              'V10693725',
                              'V62774450',
                              'V73726273',
                              'V24342827',
                              'V92299092',
                              'V85174160',
                              'V93304459',
                              'V47836600',
                              'V41374838',
                              'V78021793',
                              'V59054623',
                              'V57890617',
                              'V70382321',
                              'V28797990',
                              'V28500236',
                              'V94907497',
                              'V50859780',
                              'V22191825',
                              'V75405938',
                              'V38248033',
                              'V45498796',
                              'V88096585',
                              'V15698626',
                              'V54647811',
                              'V66096503',
                              'V64604086',
                              'V33815363',
                              'V75720828',
                              'V39024348',
                              'V90987050',
                              'V52183348'
    )
;

SELECT * FROM "user" WHERE user_id = 'a7ad2010-7a25-44a0-8092-354615f157f0'
;
SELECT * FROM contract WHERE cancelation_reason LIKE '%ghost%'